<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Business Details - ClearRoute AI</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="navbar">
  <a href="home.html" class="logo">ClearRoute AI</a>
    <nav>
      <ul class="nav-links" id="navLinks">
        <li><a href="home.html">Home</a></li>
        <li id="registerLink"><a href="register.html">Register</a></li>
        <li id="loginLink"><a href="login.html">Sign In</a></li>
        <li id="signOutLink" style="display:none;"><button id="signOutBtn" class="btn">Sign Out</button></li>
      </ul>
    </nav>
  </header>

  <section class="auth-section">
  <h2>Business Details</h2>
    <form id="businessDetailsForm">
  <label for="businessName">Business Name</label>
  <input type="text" id="businessName" placeholder="Business Name" required>

  <label for="businessEmail">Business Email</label>
  <input type="email" id="businessEmail" placeholder="Business Email" required>

  <label for="businessPhone">Phone Number</label>
  <input type="tel" id="businessPhone" placeholder="Phone Number" required>

  <label for="businessAddress">Business Address</label>
  <input type="text" id="businessAddress" placeholder="Business Address" required>

  <label for="sortCode">Sort Code</label>
  <input type="text" id="sortCode" placeholder="12-34-56" pattern="[0-9]{2}-[0-9]{2}-[0-9]{2}" required>

  <label for="accountNumber">Account Number</label>
  <input type="text" id="accountNumber" placeholder="12345678" pattern="[0-9]{8}" required>

  <label for="businessLogo">Business Logo</label>
  <input type="file" id="businessLogo" accept="image/*">

  <button type="submit" class="btn primary">Save Details</button>
    </form>
    <div id="businessDetailsMessage"></div>
  </section>

  <script>
    // Initialize Supabase client (only once)
    const SUPABASE_URL = 'https://oneixiqdahcwktickplx.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9uZWl4aXFkYWhjd2t0aWNrcGx4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgzMTYwNDMsImV4cCI6MjA3Mzg5MjA0M30.xPljznEkOi9HTW0FugQ-ksLqUA91o7HTGRi069EN430';
    window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Show/hide nav links based on authentication status
    async function updateNavLinks() {
      let isLoggedIn = false;
      if (window.supabase) {
        const { data: sessionData } = await window.supabase.auth.getSession();
        isLoggedIn = !!sessionData.session;
      }
      document.getElementById('registerLink').style.display = isLoggedIn ? 'none' : 'inline';
      document.getElementById('loginLink').style.display = isLoggedIn ? 'none' : 'inline';
      document.getElementById('signOutLink').style.display = isLoggedIn ? 'inline' : 'none';
    }
    updateNavLinks();

    // Hide nav links immediately if already logged in (for fast UI)
    window.addEventListener('DOMContentLoaded', updateNavLinks);

    document.getElementById('signOutBtn').addEventListener('click', async function() {
      if (window.supabase) {
        await window.supabase.auth.signOut();
      }
      localStorage.removeItem('access_token');
      window.location.href = 'login.html';
    });

    document.getElementById('businessDetailsForm').addEventListener('submit', async function(e) {
      e.preventDefault();

      // Collect form data
      const name = document.getElementById('businessName').value;
      const email = document.getElementById('businessEmail').value;
      const phone = document.getElementById('businessPhone').value;
      const address = document.getElementById('businessAddress').value;
      const sort_code = document.getElementById('sortCode').value;
      const account_number = document.getElementById('accountNumber').value;
      const logoInput = document.getElementById('businessLogo');
      let logo_url = '';
      if (logoInput.files && logoInput.files[0]) {
        // You can implement actual upload logic here
        logo_url = 'uploaded_logo_url.png';
      }

      // Get access token from localStorage
      const accessToken = localStorage.getItem('access_token');
      if (!accessToken) {
        document.getElementById('businessDetailsMessage').textContent = 'User not authenticated.';
        return;
      }

      // Navigate instantly to subscription page
      window.location.href = "subscription.html";

      // Continue saving details in the background
      try {
        const response = await fetch('http://localhost:3000/api/user/business/details', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${accessToken}`
          },
          body: JSON.stringify({
            name,
            email,
            phone,
            address,
            sort_code,
            account_number,
            logo_url
          })
        });

        const result = await response.json();

        if (result.success) {
          console.log('Business details saved successfully:', result);
        } else {
          console.error('Error saving business details:', result.error || 'Could not save details');
        }
      } catch (error) {
        console.error('Failed to save business details:', error);
      }
    });
  </script>
</body>
</html>
